---
title: Docker
date: 2023/08/28 21:21:19
tags: 
 - Docker
categories: 
 - Docker
---



微服务核心的一个是基于业务逻辑和不同的并发规模

docker基于cgroup和namespace union FS

虚拟机和docker有什么不同？

虚拟机是基于hypervisor安装操作系统

docker在host os上有一层docker engine，本质上是一个进程；

docker-ce docker-ce-cli

docker命令

run -d -it -p -v

inspect

attach

cp

OCI runtime specification images specification 



Namespace彼此之间是隔离的，包括ipc net pid

pid 不同的namespace之间是可以有相同pid的

net 每个net ns之间有一个独立的network devices， ip addresses，ip routing tables， /proc/net

container的进程交互实际上还是在host上完成



Cgroups 用于对一个或一组进程进行资源控制和监控的机制



docker 的创新点在文件系统

典型的linux文件系统的组成

bootfs（boot file system）

rootfs



docker就是通过overlayFS 一层层叠加起来的，overlay分为两层，镜像层和容器层，其中镜像层是readonly的，容器层是可以写的，overlay会把这两层merged起来，生成一个新的层，layer的由来。



## docker 多种网络模式

null 不做任何网络配置，只启动容器

host 复用主机

container 重用其他容器

bridge 

跨主机的网络问题：overlay underlay



HOST的网桥设备

docker的驱动会自动分配一个ip给容器



## 12Factor



## docker build context

docker会把Docker所在目录的问搭建都传到docker daemon

要确保构建上下文的清晰



## bulid cache 

判断是否有可用的已存的镜像，只有不存在时才会重新构建，判断段checksum

当某一层失效时，所有层级的cache均一失效

所以变动少的应该放在下面



## 多段构建

有效减少镜像层级的方式

精简产线，把一些以来放在前期



## Dockerfile

FROM 

LABELS

RUN 容器构建时执行的命令

CMD 容器创建时运行时需要执行的命令

EXPOSE 声明需要监听的端口

ENV 声明环境变量

ADD 从源地址复制文件到目标路径，如果src是一个本地压缩文件，那么他会同时完成解压缩

COPY 只复制本地文件，不解压文件

ENTRYPOINT:定义可以执行的容器镜像入口命令

VOLUME:挂载存储卷

USER:切换运行镜像的用户和用户组

WORKDIR:工作目录



### 最佳实践

易管理、少漏洞、镜像小、层级小、利用缓存

使用的工具尽量少

能合并的层级合并到一起

低频修改的镜像放在下面

选择合理化的初始化进程

需要捕获SIGTERM信号完成子进程的优雅终止

结束僵尸进程



